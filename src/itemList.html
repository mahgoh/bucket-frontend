<!DOCTYPE html>
<html lang="en">
  <component name="head" />
  <body>
    <div id="app" class="pb-16 sm:pb-0 sm:pt-16">
      <component name="nav" props="-active;;;text-blue-500;;" />
      <component name="pagetitle" props="Bucket Items" />
      <div
        id="items"
        class="max-w-7xl mx-auto p-4 sm:px-6 lg:px-8 divide-y divide-slate-100"
      >
        <div
          class="grid grid-cols-15 gap-x-4 p-2 px-3 sm:p-3 items-center font-bold text-sm"
        >
          <div class="text-center">
            <i class="ti ti-circle-dot text-lg"></i>
          </div>
          <div class="col-span-4">Title</div>
          <div class="col-span-2">Bucket</div>
          <div class="col-span-2">Labels</div>
          <div class="col-span-2">Accomplish By</div>
          <div class="col-span-2">Accomplished On</div>
          <div class="col-span-2 text-right">Actions</div>
        </div>
      </div>
      <template id="create-button">
        <component name="button-icon" props="Create;item/create;create;plus" />
      </template>
      <template id="no-items">
        <div
          class="mx-4 border rounded-md sm:rounded-xl p-4 sm:p-6 text-center"
        >
          No bucket items yet.
        </div>
      </template>
      <template id="item">
        <div class="grid grid-cols-15 gap-x-4 p-2 px-3 sm:p-3 items-center">
          <button data-complete>
            <i data-completed class="ti text-lg"></i>
          </button>
          <a data-title class="col-span-4 truncate hover:underline"></a>
          <div class="col-span-2 text-sm">
            <a
              class="inline-block max-w-full font-medium py-1 px-2 rounded-md truncate hover:underline"
              data-color
            >
              <i class="ti mr-2" data-icon></i>
              <span data-bucket></span>
            </a>
          </div>
          <div
            data-labels
            class="col-span-2 truncate text-slate-500 text-sm"
          ></div>
          <div
            data-to-accomplish
            class="col-span-2 text-slate-500 text-sm"
          ></div>
          <div
            data-accomplished-on
            class="col-span-2 text-slate-500 text-sm"
          ></div>
          <div class="col-span-2 flex justify-end gap-x-1 sm:gap-x-2">
            <component name="button-edit" props="Edit;;edit" />
            <component name="button-delete" props="Delete;;delete" />
          </div>
        </div>
      </template>
      <component name="footer" />
      <component name="modal" />
      <script>
        async function deleteBucketItem(id) {
          try {
            await API.deleteBucketItem(id);
            redirect('/item');
          } catch (e) {
            Notification.notify(
              'Item not deleted',
              'Could not delete the bucket item. Try again later.'
            );
          }
        }

        async function changeStatus(item, completed, dateAccomplishedOn) {
          item.completed = completed;
          item.dateAccomplishedOn = dateAccomplishedOn;

          try {
            let res = await API.putBucketItem(item.id, item);
            redirect(`/item`);
          } catch (e) {
            Notification.notify(
              'Not updated.',
              'Could not update bucket item.'
            );
          }
        }

        ready(async function () {
          try {
            const items = await API.getBucketItems();

            if (items.length > 0) {
              items.forEach((item) => {
                let rules = [
                  {
                    key: 'completed',
                    classes: item.completed
                      ? [
                          'ti-circle-check',
                          'text-green-500',
                          'hover:text-red-500',
                        ]
                      : [
                          'ti-circle-dot',
                          'text-slate-500',
                          'hover:text-green-500',
                        ],
                  },
                  {
                    key: 'title',
                    textContent: item.title,
                    href: `/item/view?id=${item.id}`,
                  },
                  {
                    key: 'edit',
                    href: `/item/edit?id=${item.id}`,
                  },
                  {
                    key: 'delete',
                    listener() {
                      Modal.confirm(
                        'Delete Bucket item?',
                        `Do you really want to delete the bucket item '${item.title}'? This action cannot be undone.`,
                        async () => {
                          await deleteBucketItem(item.id);
                        }
                      );
                    },
                  },
                ];

                if (item.bucket) {
                  rules = rules.concat([
                    {
                      key: 'bucket',
                      textContent: item.bucket.name,
                    },
                    {
                      key: 'color',
                      classes: [
                        `bg-${item.bucket.color}-100`,
                        `text-${item.bucket.color}-700`,
                      ],
                      href: `/item?bucketId=${item.bucket.id}`,
                    },
                    {
                      key: 'icon',
                      classes: [`ti-${item.bucket.icon}`],
                    },
                  ]);
                }

                if (item.labels.length > 0) {
                  rules.push({
                    key: 'labels',
                    html: item.labels
                      .map(
                        (label) =>
                          `<a href="/item?labelId=${label.id}" class="text-slate-500 hover:underline">#${label.name}</a>`
                      )
                      .join(' '),
                  });
                }

                if (item.completed) {
                  rules = rules.concat([
                    {
                      key: 'complete',
                      async listener() {
                        await changeStatus(item, false, null);
                      },
                    },
                    {
                      key: 'accomplished-on',
                      textContent: Format.parseDate(item.dateAccomplishedOn),
                    },
                  ]);
                } else {
                  rules.push({
                    key: 'complete',
                    async listener() {
                      Modal.prompt(
                        'Set Accomplished',
                        'When did you accomplish this bucket item?',
                        async (value) => {
                          await changeStatus(item, true, value);
                        }
                      );
                    },
                  });
                }

                if (item.dateToAccomplish) {
                  rules.push({
                    key: 'to-accomplish',
                    textContent: Format.parseDate(item.dateToAccomplish),
                  });
                }

                Template.render('#item', rules, '#items');
              });
            } else {
              Template.render('#no-items', [], '#items');
            }

            Template.render('#create-button', [], '#pagetitle');
          } catch (e) {
            console.log(e);
            Notification.notify(
              'Something went wrong',
              'Could not load bucket items.'
            );
          }
        });
      </script>
    </div>
  </body>
</html>
